---
# ==============================================================================
# Play 1: Initialize the Kubernetes Control Plane on the First Master (k8s-master1)
# ==============================================================================
- name: 1. INITIALIZE KUBERNETES AND DEPLOY CNI ON FIRST MASTER
  hosts: k8s-master1
  become: true

  tasks:
  - name: Ensure sysctl for bridge networking is set (required for K8s)
    sysctl:
      name: net.bridge.bridge-nf-call-iptables
      value: 1
      state: present
      reload: yes

  - name: Ensure /etc/containerd exists (just in case)
    file:
      path: /etc/containerd
      state: directory
      mode: '0755'


  - name: Run kubeadm init (first master)
    command: kubeadm init --control-plane-endpoint="{{ control_plane_endpoint }}" --upload-certs --apiserver-advertise-address={{ ansible_host }} --pod-network-cidr={{ pod_network_cidr }} --v=5
    args:
      creates: /etc/kubernetes/admin.conf
    register: kubeadm_init

  - name: Save kubeadm init output to a file
    copy:
      dest: /var/log/kubeadm-init.log
      content: "{{ kubeadm_init.stdout }}

        {{ kubeadm_init.stderr }}"
      owner: root
      group: root
      mode: '0644'

  - name: Create kube config dir for getfee
    file:
      path: /home/getfee/.kube
      state: directory
      owner: getfee
      group: getfee
      mode: '0755'

  - name: Copy admin.conf to getfee kube config
    copy:
      src: /etc/kubernetes/admin.conf
      dest: /home/getfee/.kube/config
      remote_src: yes
      owner: getfee
      group: getfee
      mode: '0644'
